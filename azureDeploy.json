{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "CustomerName": {
            "type": "string",
            "metadata": {
                "description": "The name of the customer to deploy."
            },
            "minLength": 1
        },
        "ServerFarmsSkuName": {
            "type": "string",
            "defaultValue": "F1",
            "allowedValues": ["F1", "D1", "B1", "B2", "B3", "S1", "S2", "S3", "P1", "P2", "P3", "P4"]
        },
        "ServerFarmsSkuCapacity": {
            "type": "int",
            "defaultValue": 1,
            "minValue": 1,
            "metadata": {
                "description": "Describes plan's instance count."
            }
        },
        "PackageUri": {
            "type": "string",
            "defaultValue": "https://github.com/djpericsson/AzureWebAppDeploy/raw/master/alis.zip",
            "minLength": 1,
            "metadata": {
                "description": "The application package URI."
            }
        }
    },
    "variables": {
        "uniqueString": "[uniqueString(subscription().id, deployment().name)]",
        "sku": "Free",
        "tags": {
            "Customer": "[parameters('CustomerName')]",
            "Solution": "[variables('uniqueString')]"
        },
        "containerName": "artifacts",
        "dynamicsAxUri": "[concat('https://', subscription().id,'.azurewebsites.net')]"
    },
    "resources": [
        {
            "name": "[variables('uniqueString')]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2018-02-01",
            "location": "[resourcegroup().location]",
            "tags": "[variables('tags')]",
            "kind": "StorageV2",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "accessTier": "Hot"
            },
            "resources": [
                {
                    "name": "[concat('default/', variables('containerName'))]",
                    "type": "blobServices/containers",
                    "apiVersion": "2018-07-01",
                    "dependsOn": ["[variables('uniqueString')]"]
                }
            ]
        },
        {
            "name": "[concat(variables('uniqueString'), '/default')]",
            "type": "Microsoft.Storage/storageAccounts/blobServices",
            "condition": "[not(empty(variables('dynamicsAxUri')))]",
            "apiVersion": "2018-07-01",
            "dependsOn": ["[variables('uniqueString')]"],
            "properties": {
                "cors": {
                    "corsRules": [
                        {
                            "allowedOrigins": ["[variables('dynamicsAxUri')]"],
                            "allowedMethods": ["GET"],
                            "maxAgeInSeconds": 200,
                            "exposedHeaders": ["x-ms-meta-*"],
                            "allowedHeaders": ["x-ms-meta-abc", "x-ms-meta-data*", "x-ms-meta-target*"]
                        }
                    ]
                }
            }
        },
        {
            "name": "[variables('uniqueString')]",
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "2015-10-31",
            "location": "[resourceGroup().location]",
            "tags": "[variables('tags')]",
            "dependsOn": [],
            "properties": {
                "sku": {
                    "name": "[variables('sku')]"
                }
            }
        },
        {
            "apiVersion": "2017-08-01",
            "name": "[variables('uniqueString')]",
            "type": "Microsoft.Web/serverfarms",
            "location": "[resourceGroup().location]",
            "tags": "[variables('tags')]",
            "sku": {
                "name": "[parameters('ServerFarmsSkuName')]",
                "capacity": "[parameters('ServerFarmsSkuCapacity')]"
            },
            "properties": {
                "name": "[variables('uniqueString')]"
            }
        },
        {
            "apiVersion": "2015-08-01",
            "name": "[variables('uniqueString')]",
            "type": "Microsoft.Web/sites",
            "location": "[resourceGroup().location]",
            "tags": {
                "[concat('hidden-related:', resourceGroup().id, '/providers/Microsoft.Web/serverfarms/', variables('uniqueString'))]": "Resource",
                "displayName": "Website"
            },
            "dependsOn": ["[resourceId('Microsoft.Web/serverfarms/', variables('uniqueString'))]"],
            "properties": {
                "name": "[variables('uniqueString')]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('uniqueString'))]"
            },
            "resources": [
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[resourceGroup().location]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": ["[resourceId('Microsoft.Web/sites', variables('uniqueString'))]"],
                    "tags": {
                        "displayName": "[variables('uniqueString')]"
                    },
                    "properties": {
                        "packageUri": ["parameters('PackageUri')"],
                        "dbType": "None",
                        "connectionString": "",
                        "setParameters": {
                            "IIS Web Application Name": "[variables('uniqueString')]"
                        }
                    }
                },
                {
                    "apiVersion": "2015-08-01",
                    "name": "appsettings",
                    "type": "config",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/Sites', variables('uniqueString'))]",
                        "[concat('Microsoft.Web/Sites/', variables('uniqueString'), '/Extensions/MSDeploy')]"
                    ],
                    "properties": {}
                },
                {
                    "apiVersion": "2015-08-01",
                    "name": "connectionstrings",
                    "type": "config",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/Sites', variables('uniqueString'))]",
                        "[concat('Microsoft.Web/Sites/', variables('uniqueString'), '/Extensions/MSDeploy')]"
                    ],
                    "properties": {
                        "StorageConnection": {
                            "value": "Connection",
                            "Name": "StorageConnection",
                            "type": "Custom"
                        },
                        "KeyValueStorageConnection": {
                            "value": "Connection",
                            "Name": "KeyValueStorageConnection",
                            "type": "Custom"
                        }
                    }
                }
            ]
        }
    ]
}
